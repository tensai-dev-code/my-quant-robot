name: Quant Bot Operations

on:
  # 1. ì›”~ê¸ˆ í•œêµ­ì‹œê°„ ì˜¤í›„ 6ì‹œ ìë™ ì‹¤í–‰ ì„¤ì •
  schedule:
    - cron: '0 9 * * 1-5' 

  # 2. ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜ ì„¤ì •
  workflow_dispatch:
    inputs:
      job:
        description: 'ì‹¤í–‰í•  ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”'
        required: true
        default: 'daily_full_process'
        type: choice
        options:
          - daily_full_process  # ì „ì²´ ìë™ ê³µì • (ìˆ˜ì§‘+ì¶”ì¶œ+ëˆ„ì +ì¶”ì²œ)
          - all_stocks          # ì „ì²´ì¢…ëª© ë¦¬ìŠ¤íŠ¸ë§Œ ê°±ì‹ 
          - quant_target        # í€€íŠ¸ëŒ€ìƒ 250ê°œ ì¶”ì¶œ
          - yearly_data         # 1ë…„ì¹˜ ìƒì„¸ë°ì´í„° ì´ˆê¸°í™” ìˆ˜ì§‘
          - daily_recommend     # ì˜¤ëŠ˜ ì¢…ëª© ì¶”ì²œë§Œ ì‹¤í–‰

jobs:
  execute:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          pip install finance-datareader gspread oauth2client pandas google-generativeai

      - name: Run Script
        env:
          GCP_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python run_bot.py ${{ github.event.inputs.job || 'daily_full_process' }}

      # [ì¤‘ìš”] ì´ë©”ì¼ ë³¸ë¬¸ íŒŒì¼ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë‹¨ê³„
      - name: Check if email body exists
        id: check_file
        run: |
          if [ -f "email_body.html" ]; then
            echo "should_send=true" >> $GITHUB_OUTPUT
          else
            echo "should_send=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Mail
        # íŒŒì¼ì´ ìˆì„ ë•Œë§Œ ë©”ì¼ ë°œì†¡ ì‹¤í–‰
        if: steps.check_file.outputs.should_send == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸš€ ì˜¤ëŠ˜ì˜ í€€íŠ¸ ì¶”ì²œ ì¢…ëª© ë¦¬ìŠ¤íŠ¸"
          to: "leedch@gabiacns.com"
          from: "Quant Bot <${{ secrets.EMAIL_USER }}>"
          html_body: file://email_body.html
        
